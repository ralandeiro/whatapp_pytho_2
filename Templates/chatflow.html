{% extends "base.html" %}

{% block content %}
<div class="flex h-[calc(100vh-5rem)] bg-white rounded-xl shadow-lg overflow-hidden border border-gray-200">
    
    <div class="w-1/3 border-r border-gray-200 flex flex-col bg-gray-50">
        <div class="p-4 border-b bg-white flex justify-between items-center">
            <h2 class="font-bold text-gray-700">Conversas</h2>
            <div class="flex gap-1">
                <button onclick="loadChats('todos')" class="p-2 rounded hover:bg-gray-100 text-gray-500" title="Todas"><i class="fa-solid fa-list"></i></button>
                <button onclick="loadChats('nao_lidos')" class="p-2 rounded hover:bg-gray-100 text-blue-500" title="Não Lidas"><i class="fa-solid fa-envelope"></i></button>
                <button onclick="loadChats('meus')" class="p-2 rounded hover:bg-gray-100 text-purple-500" title="Atribuídas a Mim"><i class="fa-solid fa-user"></i></button>
            </div>
        </div>
        
        <div id="chatList" class="flex-1 overflow-y-auto">
            <div class="p-4 text-center text-gray-400 text-sm">Carregando...</div>
        </div>
    </div>

    <div class="w-1/2 flex flex-col bg-[#e5ddd5] relative">
        <div id="chatHeader" class="h-16 bg-gray-100 border-b flex items-center px-4 justify-between hidden">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 rounded-full bg-gray-300 flex items-center justify-center text-gray-500"><i class="fa-solid fa-user"></i></div>
                <div>
                    <h3 id="activeChatName" class="font-bold text-gray-800">Nome Cliente</h3>
                    <p id="activeChatPhone" class="text-xs text-gray-500">Telefone</p>
                </div>
            </div>
            <div class="flex gap-2">
                <span id="activeChatStatus" class="px-2 py-1 rounded text-xs font-bold bg-green-100 text-green-800">Aberto</span>
            </div>
        </div>

        <div id="emptyState" class="flex-1 flex flex-col items-center justify-center text-gray-500">
            <i class="fa-brands fa-whatsapp text-6xl mb-4 text-gray-300"></i>
            <p>Selecione uma conversa para iniciar</p>
        </div>

        <div id="messagesArea" class="flex-1 overflow-y-auto p-4 space-y-3 hidden" style="background-image: url('https://user-images.githubusercontent.com/15075759/28719144-86dc0f70-73b1-11e7-911d-60d70fcded21.png'); opacity: 0.9;">
            </div>

        <div id="inputArea" class="bg-gray-100 p-3 border-t hidden">
            <div class="flex gap-2 items-end">
                <button class="p-2 text-gray-500 hover:text-gray-700"><i class="fa-solid fa-paperclip"></i></button>
                <textarea id="msgInput" rows="1" class="flex-1 p-2 rounded-lg border border-gray-300 focus:ring-2 focus:ring-green-500 resize-none" placeholder="Digite sua mensagem..."></textarea>
                <button onclick="sendMessage()" class="p-2 bg-green-600 text-white rounded-full hover:bg-green-700 shadow-md w-10 h-10 flex items-center justify-center">
                    <i class="fa-solid fa-paper-plane"></i>
                </button>
            </div>
        </div>
    </div>

    <div class="w-1/6 bg-white border-l border-gray-200 p-4 hidden" id="detailsPanel">
        <h4 class="font-bold text-gray-700 mb-4 text-sm uppercase">Gestão</h4>
        
        <div class="space-y-4">
            <div>
                <label class="text-xs font-bold text-gray-500">Atribuir a:</label>
                <select id="assignSelect" onchange="updateChat('agente')" class="w-full p-2 border rounded text-sm mt-1">
                    <option value="">-- Ninguém --</option>
                    {% for a in agentes %}
                    <option value="{{ a.id }}">{{ a.username }}</option>
                    {% endfor %}
                </select>
            </div>

            <div>
                <label class="text-xs font-bold text-gray-500">Status:</label>
                <select id="statusSelect" onchange="updateChat('status')" class="w-full p-2 border rounded text-sm mt-1">
                    <option value="aberto">Aberto</option>
                    <option value="resolvido">Resolvido</option>
                    <option value="arquivado">Arquivado</option>
                </select>
            </div>

            <div>
                <label class="text-xs font-bold text-gray-500">Etiquetas:</label>
                <div id="tagList" class="flex flex-wrap gap-1 mt-2 mb-2">
                    </div>
                <div class="flex gap-1">
                    <input type="text" id="newTag" placeholder="Nova tag" class="w-full p-1 border rounded text-xs">
                    <button onclick="addTag()" class="bg-blue-500 text-white px-2 rounded text-xs">+</button>
                </div>
            </div>

            <div class="border-t pt-4">
                <label class="text-xs font-bold text-gray-500">Respostas Rápidas:</label>
                <div class="space-y-1 mt-2 max-h-40 overflow-y-auto">
                    {% for t in templates %}
                    <button onclick="insertTemplate(`{{ t.conteudo_dict.content or t.conteudo_dict.text }}`)" class="w-full text-left text-xs p-2 bg-gray-50 hover:bg-gray-100 rounded truncate border">
                        {{ t.nome }}
                    </button>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>

<script>
let currentChatId = null;

// --- CARREGAR LISTA DE CONVERSAS ---
function loadChats(filter = 'todos') {
    const list = document.getElementById('chatList');
    // Spinner simples
    list.innerHTML = '<div class="p-4 text-center"><i class="fa-solid fa-spinner animate-spin"></i></div>';
    
    fetch(`/api/chats?filtro=${filter}`)
        .then(r => r.json())
        .then(data => {
            list.innerHTML = '';
            if(data.length === 0) list.innerHTML = '<div class="p-4 text-center text-gray-400 text-sm">Nenhuma conversa encontrada.</div>';
            
            data.forEach(chat => {
                const activeClass = (chat.id === currentChatId) ? 'bg-gray-200' : 'hover:bg-gray-100';
                const tagsHtml = chat.etiquetas.map(t => `<span class="bg-blue-100 text-blue-800 text-[9px] px-1 rounded">${t}</span>`).join('');
                
                const html = `
                <div onclick="openChat(${chat.id}, '${chat.nome}', '${chat.telefone}', ${chat.agente_id}, '${chat.status}', '${JSON.stringify(chat.etiquetas).replace(/"/g, '&quot;')}')" 
                     class="p-3 border-b cursor-pointer ${activeClass} transition">
                    <div class="flex justify-between">
                        <span class="font-bold text-sm text-gray-800">${chat.nome}</span>
                        <span class="text-[10px] text-gray-400">${chat.hora}</span>
                    </div>
                    <div class="text-xs text-gray-500 truncate mt-1">${chat.ultima_msg || '...'}</div>
                    <div class="mt-2 flex gap-1">${tagsHtml}</div>
                </div>`;
                list.innerHTML += html;
            });
        });
}

// --- ABRIR UM CHAT ---
function openChat(id, nome, fone, agenteId, status, tags) {
    currentChatId = id;
    document.getElementById('emptyState').classList.add('hidden');
    document.getElementById('chatHeader').classList.remove('hidden');
    document.getElementById('messagesArea').classList.remove('hidden');
    document.getElementById('inputArea').classList.remove('hidden');
    document.getElementById('detailsPanel').classList.remove('hidden');

    // Preenche Header
    document.getElementById('activeChatName').innerText = nome;
    document.getElementById('activeChatPhone').innerText = fone;
    document.getElementById('activeChatStatus').innerText = status.toUpperCase();

    // Preenche Detalhes
    document.getElementById('assignSelect').value = agenteId || "";
    document.getElementById('statusSelect').value = status;
    renderTags(JSON.parse(tags));

    // Carrega Mensagens
    loadMessages(id);
    
    // Atualiza visual da lista
    loadChats(); 
}

// --- CARREGAR MENSAGENS ---
function loadMessages(id) {
    const area = document.getElementById('messagesArea');
    area.innerHTML = ''; // Limpa
    
    fetch(`/api/messages/${id}`)
        .then(r => r.json())
        .then(msgs => {
            msgs.forEach(m => {
                const align = m.lado === 'right' ? 'items-end' : 'items-start';
                const bg = m.lado === 'right' ? 'bg-green-100' : 'bg-white';
                
                const html = `
                <div class="flex flex-col ${align}">
                    <div class="${bg} p-2 rounded-lg shadow-sm max-w-[70%] text-sm">
                        <p class="text-gray-800 whitespace-pre-wrap">${m.conteudo}</p>
                        <div class="text-[10px] text-gray-400 text-right mt-1">${m.hora}</div>
                    </div>
                </div>`;
                area.innerHTML += html;
            });
            area.scrollTop = area.scrollHeight; // Rola para o fim
        });
}

// Lógica da Imagem
    const imgEl = document.getElementById('activeChatImg');
    const iconEl = document.getElementById('activeChatIcon');
    
    if(fotoUrl && fotoUrl !== 'null') {
        imgEl.src = fotoUrl;
        imgEl.classList.remove('hidden');
        iconEl.classList.add('hidden');
    } else {
        // Se não tem foto, tenta buscar agora (Lazy Load)
        fetch('/api/chat/update_profile', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({chat_id: id})
        }).then(r=>r.json()).then(d => {
            if(d.url) {
                imgEl.src = d.url;
                imgEl.classList.remove('hidden');
                iconEl.classList.add('hidden');
            }
        });
        imgEl.classList.add('hidden');
        iconEl.classList.remove('hidden');
    }

// Adicione isto para detectar digitação
document.getElementById('msgInput').addEventListener('input', () => {
    clearTimeout(typingTimer);
    typingTimer = setTimeout(() => {
        if(currentChatId) {
            fetch('/api/chat/presence', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({chat_id: currentChatId})
            });
        }
    }, 500);
});


// --- ENVIAR MENSAGEM ---
function sendMessage() {
    const input = document.getElementById('msgInput');
    const texto = input.value.trim();
    if(!texto || !currentChatId) return;

    input.value = ''; // Limpa input
    
    // Adiciona visualmente antes de confirmar (Otimista)
    const area = document.getElementById('messagesArea');
    area.innerHTML += `
    <div class="flex flex-col items-end opacity-50">
        <div class="bg-green-100 p-2 rounded-lg shadow-sm max-w-[70%] text-sm">
            <p class="text-gray-800">${texto}</p>
            <div class="text-[10px] text-gray-400 text-right">Enviando...</div>
        </div>
    </div>`;
    area.scrollTop = area.scrollHeight;

    fetch('/api/send', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({chat_id: currentChatId, texto: texto})
    }).then(r => r.json()).then(data => {
        if(data.status === 'ok') loadMessages(currentChatId); // Recarrega para confirmar
        else alert('Erro ao enviar: ' + data.error);
    });
}

// --- AÇÕES DE GESTÃO ---
function updateChat(field) {
    if(!currentChatId) return;
    const payload = {chat_id: currentChatId};
    
    if(field === 'agente') payload.agente_id = document.getElementById('assignSelect').value;
    if(field === 'status') payload.status = document.getElementById('statusSelect').value;
    
    fetch('/api/update_chat', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(payload)
    });
}

function renderTags(tags) {
    const container = document.getElementById('tagList');
    container.innerHTML = '';
    tags.forEach(t => {
        container.innerHTML += `
        <span class="bg-gray-200 px-2 py-1 rounded text-xs flex items-center gap-1">
            #${t} <i onclick="removeTag('${t}')" class="fa-solid fa-xmark cursor-pointer hover:text-red-500"></i>
        </span>`;
    });
    // Salva no dataset para uso posterior
    container.dataset.tags = JSON.stringify(tags);
}

function addTag() {
    const input = document.getElementById('newTag');
    const tag = input.value.trim();
    if(!tag || !currentChatId) return;
    
    fetch('/api/update_chat', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({chat_id: currentChatId, etiqueta_add: tag})
    }).then(() => {
        let tags = JSON.parse(document.getElementById('tagList').dataset.tags || '[]');
        tags.push(tag);
        renderTags(tags);
        input.value = '';
    });
}

function removeTag(tag) {
    if(!currentChatId) return;
    fetch('/api/update_chat', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({chat_id: currentChatId, etiqueta_remove: tag})
    }).then(() => {
        let tags = JSON.parse(document.getElementById('tagList').dataset.tags || '[]');
        tags = tags.filter(t => t !== tag);
        renderTags(tags);
    });
}

function insertTemplate(text) {
    document.getElementById('msgInput').value = text;
    document.getElementById('msgInput').focus();
}

// Load inicial
loadChats();
</script>
{% endblock %}